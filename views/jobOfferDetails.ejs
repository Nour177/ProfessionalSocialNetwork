<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post a Job Offer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/acceuil.css">
    <script src="/jq/jquery-3.7.1.min.js"></script>
    <script type="module" src="/jq/job_post.js"></script>
</head>
<body>

<div id="navbar"></div>
<script src="/js/loadNavbar.js"></script>

<div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow-sm">
                    <form action="#" method="POST" id="jobPostForm">
                        <div class="card-header bg-white border-0 py-4">
                            <% if (locals.userId && locals._doc.postedBy._id && locals._doc.postedBy._id.toString() === locals.userId.toString()) { %>
                                <div class="mt-3">
                                    <div class="text-end">
                                    <a href="/jobs/edit/<%= locals._doc._id %>" class="btn btn-outline-secondary me-2">
                                        <i class="bi bi-pencil"></i> Edit
                                    </a>

                                    <a href="/applications/job/<%= locals._doc._id %>" class="btn btn-outline-success me-2">
                                        <i class="bi bi-people-fill"></i> View Applicants
                                    </a>

                                    <button onclick="deleteJob('<%= locals._doc._id %>')" class="btn btn-outline-danger">
                                        <i class="bi bi-trash"></i> Delete
                                    </button>
                                    </div>
                                    <div class="text-start">
                                        <div id="formMessages" class="mt-3"></div>
                                    </div>
                                </div>
                            <% } %>
                            <span class="d-flex align-items-center mb-3">
                                <% if (locals.logo) {%>
                                    <img src="<%= locals.logo %>" alt="Company Logo" class="rounded-circle me-2" style="width: 60px; height: 60px; object-fit: cover;">
                                    <a href="/company/<%= locals._id %>" class="text-decoration-none">
                                    <h5 class="mb-0"> <%= locals.name %></h5>
                                    </a>
                                <%} else { %>  
                                    <a href="/company/<%= locals._id %>" class="text-decoration-none">
                                    <h5 class="mb-0"> <%= locals.name %></h5>
                                    </a>
                                <%}%>
                            </span>
                            <h3 ><%= locals._doc.title %></h3>
                              <% if (locals.location) {%>
                                <p class="text-secondary mb-0"> Headquarters: <%= locals.location %></p>
                              <%}%>
                                <p class="text-secondary">Job Location: <%= locals.jobLocation %></p>

                            <button type="button" class="btn btn-primary btn-sm mt-2" style="width: fit-content; background-color: transparent; border: 1px solid #666666; color: #666666; font-weight: 600; cursor: default;">
                                <%= locals._doc.employmentType %> 
                            </button>

                            <% if (locals.hasApplied) { %>
                                <button type="button" class="btn btn-primary btn-sm mt-2" style="width: fit-content;" disabled>
                                    <i class="bi bi-check-circle-fill"></i> Applied
                                </button>
                            <% } else { %>
                                <button id="applyBtn" type="button" class="btn btn-primary btn-sm mt-2" style="width: fit-content;" data-job-id = "<%= locals._doc._id%>">
                                    Apply Now <i class="bi bi-box-arrow-up-right me-1"></i> 
                                </button>
                            <% } %>

                        </div>
                        <div class="card-body">
                            <h5 class="fw-bold mb-3">Meet the Hiring Team</h5>
                            <div class="d-flex align-items-center mb-3">
                                <img src="<%= locals._doc.postedBy.profileImagePath || '/images/profile.png' %>" 
                                    alt="Manager Profile"
                                    class="rounded-circle me-3 border" 
                                    style="width: 50px; height: 50px; object-fit: cover; min-width: 50px;"
                                    onerror="this.src='/images/profile.png'" />

                                <div class="d-flex flex-column justify-content-center lh-sm">
                                    <a href="/profile/<%= locals._doc.postedBy._id %>">
                                    <h6 class="fw-bold text-dark mb-0">
                                        <%=locals._doc.postedBy.firstname%> <%=locals._doc.postedBy.lastname%>
                                    </h6>
                                    </a>
                                    
                                    <% if (locals._doc.postedBy.description) { %>
                                    <span class="text-secondary small fw-light">
                                        <%=locals._doc.postedBy.description%>
                                    </span>
                                    <% } %>
                                    
                                </div>
                            </div>
                            <h5 class="fw-bold mb-3 mt-3">About the Job</h5>
                            <% if(locals.description){ %>
                                <h6> Who are we ?</h6>
                                <p><%= locals.description %></p>
                            <% } %>
                            <h6> Job description</h6>
                            <p><%= locals._doc.description %></p>
       

                                


</body>
<script>
    async function deleteJob(jobId) {
        const isConfirmed = confirm("Are you sure you want to delete this job offer? This action cannot be undone.");
        
        if (!isConfirmed) {
            document.getElementById("formMessages").innerHTML = `<div class="alert alert-success">Delete action cancelled</div>`
            return;} 

        try {
            const response = await fetch(`/jobs/delete/${jobId}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            const result = await response.json();

            if (result.success) {
                document.getElementById("formMessages").innerHTML = `<div class="alert alert-success">${result.message}</div>`
                setTimeout(() => {
                    window.location.href = result.redirectUrl;
                }, 2000);
            } else {
                document.getElementById("formMessages").innerHTML = `<div class="alert alert-danger">${result.message}</div>`
            }

        } catch (error) {
            console.error("Delete failed:", error);
            document.getElementById("formMessages").innerHTML = `<div class="alert alert-danger">Something went wrong. Please try again.</div>`
        }
    }
</script>
</html>